name: Flip CI to Hard

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

permissions: read-all

jobs:
  detect-and-flip:
    runs-on: ubuntu-latest
    env:
      REQUIRED_CHECKS: |-
        CodeQL (soft)
        Gitleaks (soft)
        Dependency Review (soft)
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Detect first real code on main
        id: detect
        run: bash scripts/ci/detect-first-real-merge.sh
      - name: Flip to hard (set branch protection required checks)
        if: steps.detect.outputs.FIRST_REAL_CODE_COMMIT != ''
        uses: actions/github-script@v7
        env:
          CHECKS: ${{ env.REQUIRED_CHECKS }}
        with:
          github-token: ${{ secrets.ADMIN_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const branch = 'main';
            const checks = process.env.CHECKS.split('\n').map(s => s.trim()).filter(Boolean);
            // Fetch existing protection
            let prot;
            try {
              const res = await github.rest.repos.getBranchProtection({ owner, repo, branch });
              prot = res.data;
            } catch (e) {
              prot = {};
            }
            const required_status_checks = {
              strict: true,
              contexts: checks
            };
            const required_pull_request_reviews = prot.required_pull_request_reviews || { required_approving_review_count: 1 };
            const restrictions = prot.restrictions || null;
            await github.rest.repos.updateBranchProtection({
              owner, repo, branch,
              required_status_checks,
              enforce_admins: true,
              required_pull_request_reviews,
              restrictions
            });
            core.info('Branch protection updated: required checks set and admins enforced.');
      - name: Note
        if: steps.detect.outputs.FIRST_REAL_CODE_COMMIT == ''
        run: echo "Flip not executed â€” no real code on main yet or detection not met."
